<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIG Mock Assessment ‚Äî 3 Partes + Grabaci√≥n + R√∫brica + Instructor</title>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --panel2:#fbfbfe;
      --text:#1c2430; --muted:#5b6b7e;
      --border:rgba(20,35,55,.14); --shadow:0 10px 28px rgba(18,28,45,.08);
      --accent:#d61f26; --good:#0ea56b; --warn:#c97a00;
      --softRed:#ffe7e8; --softBlue:#eaf2ff; --softGray:#f1f3f7;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(214,31,38,.10), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(70,130,255,.10), transparent 55%),
        linear-gradient(180deg,#fff,var(--bg));
      min-height:100vh;
    }
    header{max-width:1180px;margin:0 auto;padding:22px 16px 12px}
    .brand{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(214,31,38,.12)}
    h1{margin:0;font-size:18px}
    p{margin:6px 0;color:var(--muted);line-height:1.45}
    .wrap{max-width:1180px;margin:0 auto;padding:0 16px 44px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;margin:12px 0 14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:rgba(255,255,255,.75);padding:10px 12px;border-radius:14px;cursor:pointer}
    .tab[aria-selected="true"]{border-color:rgba(214,31,38,.45);background:rgba(214,31,38,.06);box-shadow:0 0 0 3px rgba(214,31,38,.14) inset}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:1000px){.grid{grid-template-columns:1.15fr .85fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:14px 14px 12px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px;font-size:15px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--border);background:var(--panel2);padding:10px 12px;border-radius:14px;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.primary{border-color:rgba(214,31,38,.55);background:rgba(214,31,38,.08)}
    .btn.good{border-color:rgba(14,165,107,.45);background:rgba(14,165,107,.08)}
    .btn.warn{border-color:rgba(201,122,0,.45);background:rgba(201,122,0,.08)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);background:rgba(255,255,255,.7)}
    .pill strong{color:var(--text)}
    .select,.input{background:#fff;border:1px solid var(--border);padding:9px 10px;border-radius:14px}
    .divider{height:1px;background:rgba(20,35,55,.10);margin:10px 0}
    .prompt{margin-top:10px;padding:12px;border-radius:16px;background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid var(--border)}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .badge{font-size:12px;padding:5px 9px;border-radius:999px;border:1px solid var(--border);background:var(--softGray);color:var(--muted)}
    .badge.en{border-color:rgba(70,130,255,.35);background:var(--softBlue);color:#254a9a}
    .badge.es{border-color:rgba(14,165,107,.35);background:rgba(14,165,107,.10);color:#0a6b48}
    .badge.rec{border-color:rgba(214,31,38,.35);background:var(--softRed);color:#8a1014}
    .badge.lock{border-color:rgba(20,35,55,.20);background:#fff;color:#2c3646}
    .text{font-size:15px;line-height:1.5}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none!important}
    .listScroll{max-height:560px;overflow:auto;padding-right:4px}
    audio{width:100%;border-radius:14px}
    .notice{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(214,31,38,.25);background:rgba(214,31,38,.06);color:#7b1215;font-size:12px;line-height:1.4}
    .rubricGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width:650px){.rubricGrid{grid-template-columns:1fr 1fr 1fr 1fr}}
    .rubricItem{border:1px solid var(--border);border-radius:14px;padding:10px;background:#fff}
    .rubricItem label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <span class="dot" aria-hidden="true"></span>
    <h1>BIG Mock Assessment ‚Äî 3 Partes + Grabaci√≥n + R√∫brica + Instructor</h1>
  </div>
  <p>Mock de pr√°ctica (no examen real): Parte 1 Sight (10), Parte 2 Di√°logo (20), Parte 3 Terminolog√≠a (40). Incluye ‚è±Ô∏ètimer, üé≤random, üîíinstructor y üìãr√∫brica.</p>

  <div id="iframeWarning" class="notice" style="display:none">
    <strong>Est√°s dentro de Google Sites (embed).</strong> Si el micr√≥fono no funciona aqu√≠:
    <div class="actions">
      <button class="btn primary" id="openNewTab">Abrir en nueva pesta√±a</button>
      <span class="pill">Soluciona bloqueos del iframe</span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="topbar">
    <div class="tabs" role="tablist">
      <button class="tab" role="tab" aria-selected="true" data-tab="overview">Resumen</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="part1">Parte 1</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="part2">Parte 2</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="part3">Parte 3</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="recordings">Mis audios</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="instructor">Instructor</button>
    </div>

    <div class="row">
      <label class="pill">Estudiante:
        <input class="input" id="studentName" placeholder="Nombre / ID" style="min-width:220px" />
      </label>
      <button class="btn good" id="saveName">Guardar</button>
      <span class="pill">Timer: <strong class="mono" id="timerRead">00:00</strong></span>
    </div>
  </div>

  <!-- RESUMEN -->
  <section id="overview" class="grid">
    <div class="card">
      <h2>Controles (las 4 funciones)</h2>
      <div class="divider"></div>

      <div class="row">
        <span class="pill"><strong>Timer por √≠tem</strong></span>
        <label class="pill">P1:
          <select class="select" id="tP1">
            <option value="40">40s</option><option value="50" selected>50s</option><option value="60">60s</option>
          </select>
        </label>
        <label class="pill">P2:
          <select class="select" id="tP2">
            <option value="35">35s</option><option value="40" selected>40s</option><option value="45">45s</option>
          </select>
        </label>
        <label class="pill">P3:
          <select class="select" id="tP3">
            <option value="6">6s</option><option value="8" selected>8s</option><option value="10">10s</option>
          </select>
        </label>
      </div>

      <div class="actions">
        <label class="pill"><input type="checkbox" id="beepOn" checked> Beep al finalizar</label>
        <label class="pill"><input type="checkbox" id="autoNext"> Auto-siguiente</label>
        <button class="btn primary" id="startTimer">‚ñ∂ Iniciar timer</button>
        <button class="btn" id="stopTimer">‚ñ† Parar timer</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <span class="pill"><strong>Randomizar</strong></span>
        <button class="btn" id="shuffleP1">Random P1</button>
        <button class="btn" id="shuffleP2">Random P2</button>
        <button class="btn" id="shuffleP3">Random P3</button>
        <button class="btn warn" id="shuffleAll">Random TODO</button>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <span class="pill">Completados: <strong id="doneCount">0</strong> / <strong id="totalCount">70</strong></span>
        <span class="pill">Promedio final: <strong id="avgScore">‚Äî</strong></span>
        <button class="btn warn" id="resetAll">Reiniciar progreso</button>
      </div>

      <div class="notice">
        <strong>Privacidad:</strong> los audios no se suben; se descargan en el equipo del estudiante.
      </div>
    </div>

    <div class="card">
      <h2>Instrucciones r√°pidas</h2>
      <div class="divider"></div>
      <ol style="margin:0;padding-left:18px;color:var(--muted);line-height:1.6">
        <li>En cada √≠tem: üéôÔ∏è Grabar ‚Üí ‚èπÔ∏è Parar ‚Üí ‚¨áÔ∏è Descargar</li>
        <li>Califica con r√∫brica: Accuracy / Completeness / Delivery / Protocol</li>
        <li>Marca ‚Äú‚úì Completado‚Äù para cerrar el √≠tem</li>
      </ol>
    </div>
  </section>

  <!-- PARTE 1 -->
  <section id="part1" class="grid hidden">
    <div class="card">
      <h2>Parte 1 ‚Äî Sight (10) (EN‚ÜíES)</h2>
      <p class="small">Lee 3‚Äì5 segundos y luego interpreta.</p>
      <div class="row">
        <button class="btn" id="p1Prev">Anterior</button>
        <button class="btn primary" id="p1Next">Siguiente</button>
        <span class="pill">√çtem: <strong id="p1Pos">1</strong>/10</span>
      </div>
      <div class="divider"></div>
      <div class="prompt" id="p1Prompt"></div>
    </div>
    <div class="card">
      <h2>Lista P1</h2>
      <div class="divider"></div>
      <div id="p1List" class="listScroll"></div>
    </div>
  </section>

  <!-- PARTE 2 -->
  <section id="part2" class="grid hidden">
    <div class="card">
      <h2>Parte 2 ‚Äî Di√°logo (20) (EN‚ÜîES)</h2>
      <p class="small">Interpreta cada turno al otro idioma.</p>
      <div class="row">
        <button class="btn" id="p2Prev">Anterior</button>
        <button class="btn primary" id="p2Next">Siguiente</button>
        <span class="pill">Turno: <strong id="p2Pos">1</strong>/20</span>
      </div>
      <div class="divider"></div>
      <div class="prompt" id="p2Prompt"></div>
    </div>
    <div class="card">
      <h2>Lista P2</h2>
      <div class="divider"></div>
      <div id="p2List" class="listScroll"></div>
    </div>
  </section>

  <!-- PARTE 3 -->
  <section id="part3" class="grid hidden">
    <div class="card">
      <h2>Parte 3 ‚Äî Terminolog√≠a (40) (EN‚ÜíES)</h2>
      <p class="small">Rendici√≥n r√°pida y clara.</p>
      <div class="row">
        <button class="btn" id="p3Prev">Anterior</button>
        <button class="btn primary" id="p3Next">Siguiente</button>
        <span class="pill">T√©rmino: <strong id="p3Pos">1</strong>/40</span>
      </div>
      <div class="divider"></div>
      <div class="prompt" id="p3Prompt"></div>
    </div>
    <div class="card">
      <h2>Lista P3</h2>
      <div class="divider"></div>
      <div id="p3List" class="listScroll"></div>
    </div>
  </section>

  <!-- AUDIOS -->
  <section id="recordings" class="grid hidden">
    <div class="card">
      <h2>Mis audios (esta sesi√≥n)</h2>
      <div class="row">
        <button class="btn good" id="downloadAll">‚¨áÔ∏è Descargar todos</button>
        <span class="pill">Audios: <strong id="recCount">0</strong></span>
      </div>
      <div class="divider"></div>
      <div id="recList"></div>
      <div class="notice">Tu navegador puede pedir confirmaci√≥n por cada descarga.</div>
    </div>
    <div class="card">
      <h2>Nota</h2>
      <div class="divider"></div>
      <p class="small">Para ‚Äúsubir autom√°tico‚Äù audios (Drive) se requiere backend/integraci√≥n.</p>
    </div>
  </section>

  <!-- INSTRUCTOR -->
  <section id="instructor" class="grid hidden">
    <div class="card">
      <h2>Modo Instructor üîí</h2>
      <div class="row">
        <span class="badge lock">Estado: <strong id="instState">Bloqueado</strong></span>
        <label class="pill">Clave:
          <input class="input" id="instPass" placeholder="1122" style="width:140px" />
        </label>
        <button class="btn primary" id="instLogin">Ingresar</button>
        <button class="btn" id="instLogout">Salir</button>
      </div>

      <div id="instPanel" class="hidden">
        <div class="divider"></div>
        <div class="row">
          <label class="pill">Nueva clave:
            <input class="input" id="newPass" placeholder="4+ d√≠gitos" style="width:160px" />
          </label>
          <button class="btn good" id="saveNewPass">Guardar clave</button>
          <button class="btn warn" id="exportScores">Exportar r√∫brica (CSV)</button>
        </div>

        <div class="divider"></div>
        <div class="row" style="justify-content:space-between">
          <span class="pill">Promedio P1: <strong class="mono" id="avgP1">‚Äî</strong></span>
          <span class="pill">Promedio P2: <strong class="mono" id="avgP2">‚Äî</strong></span>
          <span class="pill">Promedio P3: <strong class="mono" id="avgP3">‚Äî</strong></span>
        </div>
      </div>

      <div class="notice">El modo instructor se guarda por navegador/equipo.</div>
    </div>

    <div class="card">
      <h2>R√∫brica</h2>
      <div class="divider"></div>
      <ul style="margin:0;padding-left:18px;color:var(--muted);line-height:1.6">
        <li><strong>Accuracy:</strong> t√©rminos, n√∫meros, sentido.</li>
        <li><strong>Completeness:</strong> no omite ideas clave.</li>
        <li><strong>Delivery:</strong> fluidez, dicci√≥n, registro.</li>
        <li><strong>Protocol:</strong> primera persona, neutralidad, pide repetici√≥n si aplica.</li>
      </ul>
    </div>
  </section>
</div>

<script>
  // ---------- Detect iframe (Google Sites) ----------
  const inIframe = (()=>{ try{return window.self!==window.top}catch{return true} })();
  if(inIframe){
    document.getElementById("iframeWarning").style.display="block";
    document.getElementById("openNewTab").onclick=()=>window.open(window.location.href,"_blank","noopener,noreferrer");
  }

  // ---------- DATA (70) ----------
  const baseP1 = [
    { id:"P1-01", from:"EN", text:"INTERPRETER PRE-SESSION: The interpreter will interpret everything said in the first person, keep all information confidential, and may request repetition or clarification when needed." },
    { id:"P1-02", from:"EN", text:"CONSENT FOR TELEHEALTH: I understand this visit is being conducted by phone or video. I may stop the visit at any time. I agree to proceed." },
    { id:"P1-03", from:"EN", text:"MEDICATION INSTRUCTIONS: Take 1 tablet (500 mg) by mouth every 12 hours for 7 days. Finish all medication even if you feel better." },
    { id:"P1-04", from:"EN", text:"ALLERGY WARNING: Stop taking the medication and seek care immediately if you develop facial swelling, trouble breathing, or hives." },
    { id:"P1-05", from:"EN", text:"DISCHARGE: Return to the emergency room for chest pain, shortness of breath, severe headache, weakness on one side, or confusion." },
    { id:"P1-06", from:"EN", text:"LAB NOTICE: Your blood sugar is 215 mg/dL today. The provider will discuss diet changes and whether you need medication adjustments." },
    { id:"P1-07", from:"EN", text:"FOLLOW-UP: Schedule an appointment with your primary care provider within 1‚Äì2 weeks. Bring your medication bottles or an updated list." },
    { id:"P1-08", from:"EN", text:"IMAGING PREP: Do not eat or drink for 6 hours before your CT scan with contrast. Tell staff if you have kidney disease or take metformin." },
    { id:"P1-09", from:"EN", text:"PATIENT RIGHTS: You have the right to receive information in a language you understand and to ask questions about your care." },
    { id:"P1-10", from:"EN", text:"PAYMENT POLICY: Co-pay is due at the time of service. If you cannot pay today, ask about payment plans." }
  ];

  const baseP2 = [
    { id:"P2-01", from:"EN", role:"Provider", text:"Hello, this is the clinic. Before we start, can you confirm your full name and date of birth?" },
    { id:"P2-02", from:"ES", role:"Paciente", text:"S√≠, me llamo Ana Mar√≠a R√≠os y nac√≠ el 14 de marzo de 1989." },
    { id:"P2-03", from:"EN", role:"Provider", text:"Thank you. What is the main reason for your call today?" },
    { id:"P2-04", from:"ES", role:"Paciente", text:"Tengo dolor de garganta y fiebre desde hace dos d√≠as." },
    { id:"P2-05", from:"EN", role:"Provider", text:"What is your temperature, and how are you measuring it?" },
    { id:"P2-06", from:"ES", role:"Paciente", text:"Me dio 38.5 con term√≥metro digital, por la boca." },
    { id:"P2-07", from:"EN", role:"Provider", text:"Any shortness of breath, chest pain, or trouble swallowing your saliva?" },
    { id:"P2-08", from:"ES", role:"Paciente", text:"No dolor de pecho no, pero s√≠ me duele al tragar y siento el cuello inflamado." },
    { id:"P2-09", from:"EN", role:"Provider", text:"Do you have a cough? Is it dry or with mucus? Any sick contacts?" },
    { id:"P2-10", from:"ES", role:"Paciente", text:"Tengo tos seca. Mi hijo estuvo enfermo la semana pasada." },
    { id:"P2-11", from:"EN", role:"Provider", text:"Any allergies to medications? And what medicines are you taking right now?" },
    { id:"P2-12", from:"ES", role:"Paciente", text:"Soy al√©rgica a la penicilina. Estoy tomando acetaminof√©n y t√© caliente." },
    { id:"P2-13", from:"EN", role:"Provider", text:"On a scale from 0 to 10, how bad is the throat pain? Any ear pain?" },
    { id:"P2-14", from:"ES", role:"Paciente", text:"Como 7. Y s√≠, me duele un poco el o√≠do derecho." },
    { id:"P2-15", from:"EN", role:"Provider", text:"We‚Äôll do a rapid strep test and possibly a COVID/flu test. If strep is positive, we‚Äôll choose an antibiotic safe with your allergy." },
    { id:"P2-16", from:"ES", role:"Paciente", text:"¬øHoy mismo me atienden o me toca pedir cita?" },
    { id:"P2-17", from:"EN", role:"Provider", text:"We can see you today at 3:30 PM. Please arrive 15 minutes early, wear a mask, and bring your ID and insurance card." },
    { id:"P2-18", from:"ES", role:"Paciente", text:"Listo. ¬øQu√© hago si me sube m√°s la fiebre en la noche?" },
    { id:"P2-19", from:"EN", role:"Provider", text:"If your fever is 103¬∞F (39.4¬∞C) or higher, if you have difficulty breathing, or if you cannot swallow fluids, go to urgent care or the ER." },
    { id:"P2-20", from:"ES", role:"Paciente", text:"Entendido. Muchas gracias." }
  ];

  const baseP3 = [
    { id:"P3-01", from:"EN", text:"sore throat" },{ id:"P3-02", from:"EN", text:"fever" },
    { id:"P3-03", from:"EN", text:"swollen lymph nodes" },{ id:"P3-04", from:"EN", text:"earache" },
    { id:"P3-05", from:"EN", text:"dry cough" },{ id:"P3-06", from:"EN", text:"mucus / phlegm" },
    { id:"P3-07", from:"EN", text:"shortness of breath" },{ id:"P3-08", from:"EN", text:"chest pain" },
    { id:"P3-09", from:"EN", text:"trouble swallowing" },{ id:"P3-10", from:"EN", text:"rapid strep test" },
    { id:"P3-11", from:"EN", text:"allergy to penicillin" },{ id:"P3-12", from:"EN", text:"hives" },
    { id:"P3-13", from:"EN", text:"facial swelling" },{ id:"P3-14", from:"EN", text:"anaphylaxis" },
    { id:"P3-15", from:"EN", text:"side effects" },{ id:"P3-16", from:"EN", text:"dose" },
    { id:"P3-17", from:"EN", text:"every 12 hours" },{ id:"P3-18", from:"EN", text:"take with food" },
    { id:"P3-19", from:"EN", text:"finish the full course" },{ id:"P3-20", from:"EN", text:"over-the-counter medication" },
    { id:"P3-21", from:"EN", text:"acetaminophen" },{ id:"P3-22", from:"EN", text:"ibuprofen" },
    { id:"P3-23", from:"EN", text:"antibiotic" },{ id:"P3-24", from:"EN", text:"viral infection" },
    { id:"P3-25", from:"EN", text:"bacterial infection" },{ id:"P3-26", from:"EN", text:"dehydration" },
    { id:"P3-27", from:"EN", text:"nausea" },{ id:"P3-28", from:"EN", text:"vomiting" },
    { id:"P3-29", from:"EN", text:"diarrhea" },{ id:"P3-30", from:"EN", text:"abdominal pain" },
    { id:"P3-31", from:"EN", text:"blood pressure" },{ id:"P3-32", from:"EN", text:"heart rate" },
    { id:"P3-33", from:"EN", text:"oxygen saturation" },{ id:"P3-34", from:"EN", text:"telehealth visit" },
    { id:"P3-35", from:"EN", text:"urgent care" },{ id:"P3-36", from:"EN", text:"emergency room" },
    { id:"P3-37", from:"EN", text:"follow-up appointment" },{ id:"P3-38", from:"EN", text:"primary care provider" },
    { id:"P3-39", from:"EN", text:"consent" },{ id:"P3-40", from:"EN", text:"confidentiality" }
  ];

  // ---------- Storage keys ----------
  const KEY_PROGRESS="BIG_progress_v3";
  const KEY_STUDENT="BIG_student_v3";
  const KEY_ORDERS="BIG_orders_v3";
  const KEY_PASS="BIG_inst_pass_v3";
  const KEY_INST="BIG_inst_unlocked_v3";

  // ---------- State ----------
  const state={
    student: localStorage.getItem(KEY_STUDENT)||"",
    progress: JSON.parse(localStorage.getItem(KEY_PROGRESS)||"{}"),
    orders: JSON.parse(localStorage.getItem(KEY_ORDERS)||"{}"),
    idx:{p1:0,p2:0,p3:0},
    instPass: localStorage.getItem(KEY_PASS)||"1122",
    instUnlocked: localStorage.getItem(KEY_INST)==="true",
    timing:{p1:50,p2:40,p3:8},
    beepOn:true, autoNext:false,
    timer:{running:false,t:0,interval:null,section:"p1"}
  };

  // ---------- DOM helpers ----------
  const $=(id)=>document.getElementById(id);
  const esc=(s)=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function saveProgress(){ localStorage.setItem(KEY_PROGRESS, JSON.stringify(state.progress)); }
  function saveOrders(){ localStorage.setItem(KEY_ORDERS, JSON.stringify(state.orders)); }

  function fmt(sec){ return `${String(Math.floor(sec/60)).padStart(2,"0")}:${String(sec%60).padStart(2,"0")}`; }

  function langBadge(item){
    return item.from==="EN" ? `<span class="badge en">EN ‚Üí ES</span>` : `<span class="badge es">ES ‚Üí EN</span>`;
  }

  function defaultRubric(){ return {accuracy:3,completeness:3,delivery:3,protocol:3,final:3,done:false}; }
  function calcFinal(v){ return Math.round(((v.accuracy+v.completeness+v.delivery+v.protocol)/4)*100)/100; }

  // ---------- Orders / random ----------
  function applyOrder(items, order){
    if(!Array.isArray(order) || order.length!==items.length) return [...items];
    const map=new Map(items.map(x=>[x.id,x]));
    const out=[];
    for(const id of order){ const it=map.get(id); if(it) out.push(it); }
    return out.length===items.length ? out : [...items];
  }
  function shuffleArray(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }
  function setOrder(key, items){ state.orders[key]=items.map(x=>x.id); saveOrders(); }
  function getArrays(){
    const p1=applyOrder(baseP1, state.orders.p1);
    const p2=applyOrder(baseP2, state.orders.p2);
    const p3=applyOrder(baseP3, state.orders.p3);
    return {p1,p2,p3,all:[...p1,...p2,...p3]};
  }

  // ---------- Stats ----------
  function stats(){
    const {p1,p2,p3,all}=getArrays();
    const vals=Object.values(state.progress);
    const done=vals.filter(v=>v?.done).length;
    const scored=vals.filter(v=>typeof v?.final==="number");
    const avg=scored.length? scored.reduce((a,v)=>a+v.final,0)/scored.length : null;

    const avgBy=(list)=>{
      const s=list.map(it=>state.progress[it.id]).filter(v=>typeof v?.final==="number");
      return s.length? s.reduce((a,v)=>a+v.final,0)/s.length : null;
    };
    return {done,total:all.length,avg,avgP1:avgBy(p1),avgP2:avgBy(p2),avgP3:avgBy(p3)};
  }
  function updateOverview(){
    const s=stats();
    $("doneCount").textContent=s.done;
    $("totalCount").textContent=s.total;
    $("avgScore").textContent=s.avg? s.avg.toFixed(2) : "‚Äî";
    $("avgP1").textContent=s.avgP1? s.avgP1.toFixed(2) : "‚Äî";
    $("avgP2").textContent=s.avgP2? s.avgP2.toFixed(2) : "‚Äî";
    $("avgP3").textContent=s.avgP3? s.avgP3.toFixed(2) : "‚Äî";
  }

  // ---------- Beep ----------
  function beep(){
    try{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type="sine"; o.frequency.value=880; g.gain.value=0.05;
      o.connect(g); g.connect(ctx.destination); o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 140);
    }catch{}
  }

  // ---------- Timer ----------
  function stopTimer(){
    if(state.timer.interval) clearInterval(state.timer.interval);
    state.timer.interval=null; state.timer.running=false;
  }
  function startTimer(){
    stopTimer();
    state.timer.running=true; state.timer.t=0;
    $("timerRead").textContent="00:00";
    state.timer.interval=setInterval(()=>{
      state.timer.t++;
      $("timerRead").textContent=fmt(state.timer.t);
      const limit=state.timing[state.timer.section];
      if(state.timer.t>=limit){
        stopTimer();
        if(state.beepOn) beep();
        if(state.autoNext) autoAdvance();
      }
    },1000);
  }
  function setTimerSection(sec){ state.timer.section=sec; }
  function autoAdvance(){
    if(state.timer.section==="p1") $("p1Next").click();
    if(state.timer.section==="p2") $("p2Next").click();
    if(state.timer.section==="p3") $("p3Next").click();
  }

  // ---------- Recording ----------
  const recordings={};
  let micStream=null, recorder=null, currentId=null, chunks=[];
  async function ensureMic(){
    if(micStream) return micStream;
    if(!navigator.mediaDevices?.getUserMedia) throw new Error("Tu navegador no soporta grabaci√≥n.");
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    return micStream;
  }
  function pickMime(){
    if(!window.MediaRecorder) return null;
    const c=["audio/webm;codecs=opus","audio/webm","audio/mp4"];
    return c.find(t=>MediaRecorder.isTypeSupported(t))||null;
  }
  function filenameFor(id){
    const base=(state.student||"student").trim().replace(/[^\w\-]+/g,"_");
    const ts=new Date().toISOString().replace(/[:.]/g,"-");
    return `${base}_${id}_${ts}.webm`;
  }
  function setRecUI(isRec,id){
    const start=document.querySelector(`button[data-rec="start"][data-id="${id}"]`);
    const stop=document.querySelector(`button[data-rec="stop"][data-id="${id}"]`);
    const dl=document.querySelector(`button[data-rec="download"][data-id="${id}"]`);
    const st=document.getElementById(`recStatus-${id}`);
    const has=!!recordings[id];
    if(start) start.disabled=isRec;
    if(stop) stop.disabled=!isRec;
    if(dl) dl.disabled=!has;
    if(st) st.textContent=isRec?"Grabando‚Ä¶":(has?"Listo (con clip)":"Listo");
  }
  async function startRecording(id){
    if(recorder && recorder.state==="recording") return;
    await ensureMic();
    const mime=pickMime();
    if(!mime) throw new Error("MediaRecorder no disponible.");
    chunks=[]; currentId=id;
    recorder=new MediaRecorder(micStream,{mimeType:mime});
    recorder.ondataavailable=(e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
    recorder.onstop=()=>{
      const blob=new Blob(chunks,{type:mime});
      const url=URL.createObjectURL(blob);
      if(recordings[id]?.url) URL.revokeObjectURL(recordings[id].url);
      recordings[id]={url,blob,mime,filename:filenameFor(id)};
      const player=document.getElementById(`player-${id}`);
      if(player){ player.src=url; player.style.display="block"; }
      setRecUI(false,id); renderRecList(); currentId=null;
    };
    recorder.start(); setRecUI(true,id);
  }
  function stopRecording(id){
    if(!recorder || recorder.state!=="recording") return;
    if(id!==currentId) return;
    recorder.stop();
  }
  function downloadRecording(id){
    const r=recordings[id]; if(!r) return;
    const a=document.createElement("a");
    a.href=r.url; a.download=r.filename;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ---------- Rubric actions ----------
  function setRubric(id,key,val){
    const v=state.progress[id]||defaultRubric();
    v[key]=val;
    v.final=calcFinal(v);
    state.progress[id]=v;
    saveProgress(); updateOverview();
    const fin=document.getElementById(`final-${id}`);
    if(fin) fin.textContent=v.final.toFixed(2);
  }
  function markDone(id){
    const v=state.progress[id]||defaultRubric();
    v.done=true; v.final=calcFinal(v);
    state.progress[id]=v;
    saveProgress(); updateOverview(); refreshLists(); renderCurrent();
  }
  function clearItem(id){
    delete state.progress[id];
    saveProgress(); updateOverview(); refreshLists(); renderCurrent();
  }

  // ---------- Render ----------
  function rubricSelect(id,key,label,val){
    return `
      <div class="rubricItem">
        <label>${label}</label>
        <select class="select" data-rubric="1" data-id="${esc(id)}" data-key="${esc(key)}">
          ${[1,2,3,4,5].map(n=>`<option value="${n}" ${n===val?"selected":""}>${n}</option>`).join("")}
        </select>
      </div>`;
  }

  function promptHTML(item,pos,total){
    const has=!!recordings[item.id];
    const v=state.progress[item.id]||defaultRubric();
    const role=item.role? `<span class="badge">${esc(item.role)}</span>` : "";
    return `
      <div class="meta">
        <span class="pill"><strong>${esc(item.id)}</strong> ¬∑ ${pos}/${total}</span>
        ${langBadge(item)} ${role}
        <span class="badge rec">Grabaci√≥n: <strong id="recStatus-${esc(item.id)}">${has?"Listo (con clip)":"Listo"}</strong></span>
        <span class="pill">Final: <strong class="mono" id="final-${esc(item.id)}">${typeof v.final==="number"? v.final.toFixed(2) : "‚Äî"}</strong></span>
        <span class="pill">Estado: <strong style="color:${v.done?"var(--good)":"var(--warn)"}">${v.done?"Completado":"Pendiente"}</strong></span>
      </div>

      <div class="text">${esc(item.text)}</div>

      <div class="actions" style="margin-top:12px">
        <button class="btn primary" data-rec="start" data-id="${esc(item.id)}">üéôÔ∏è Grabar</button>
        <button class="btn" data-rec="stop" data-id="${esc(item.id)}" disabled>‚èπÔ∏è Parar</button>
        <button class="btn good" data-rec="download" data-id="${esc(item.id)}" ${has?"":"disabled"}>‚¨áÔ∏è Descargar</button>
        <span class="pill">Formato: <strong>webm</strong></span>
      </div>

      <audio id="player-${esc(item.id)}" controls style="margin-top:10px; display:${has?"block":"none"}" ${has?`src="${recordings[item.id].url}"`:""}></audio>

      <div class="divider"></div>
      <h2 style="margin:0 0 8px">R√∫brica (1‚Äì5)</h2>
      <div class="rubricGrid">
        ${rubricSelect(item.id,"accuracy","Accuracy",v.accuracy)}
        ${rubricSelect(item.id,"completeness","Completeness",v.completeness)}
        ${rubricSelect(item.id,"delivery","Delivery",v.delivery)}
        ${rubricSelect(item.id,"protocol","Protocol",v.protocol)}
      </div>

      <div class="actions" style="margin-top:10px">
        <button class="btn good" data-act="done" data-id="${esc(item.id)}">‚úì Completado</button>
        <button class="btn" data-act="clear" data-id="${esc(item.id)}">Limpiar</button>
      </div>
    `;
  }

  function listHTML(items, prefix){
    return items.map((it, idx)=>{
      const v=state.progress[it.id]||defaultRubric();
      const has=!!recordings[it.id];
      return `
        <div class="prompt" style="margin-bottom:10px">
          <div class="meta">
            <span class="pill"><strong>${esc(it.id)}</strong></span>
            ${langBadge(it)}
            ${it.role?`<span class="badge">${esc(it.role)}</span>`:""}
            <span class="pill">Final: <strong class="mono">${typeof v.final==="number"? v.final.toFixed(2):"‚Äî"}</strong></span>
            <span class="badge rec">Audio: <strong>${has?"S√≠":"No"}</strong></span>
          </div>
          <div class="actions">
            <button class="btn primary" data-nav="${prefix}" data-index="${idx}">Ir</button>
            <button class="btn good" data-act="done" data-id="${esc(it.id)}">‚úì</button>
            <button class="btn" data-act="clear" data-id="${esc(it.id)}">Limpiar</button>
          </div>
        </div>`;
    }).join("");
  }

  function renderCurrent(){
    const {p1,p2,p3}=getArrays();
    state.idx.p1=Math.max(0,Math.min(state.idx.p1,p1.length-1));
    state.idx.p2=Math.max(0,Math.min(state.idx.p2,p2.length-1));
    state.idx.p3=Math.max(0,Math.min(state.idx.p3,p3.length-1));

    $("p1Pos").textContent=String(state.idx.p1+1);
    $("p2Pos").textContent=String(state.idx.p2+1);
    $("p3Pos").textContent=String(state.idx.p3+1);

    $("p1Prompt").innerHTML=promptHTML(p1[state.idx.p1], state.idx.p1+1, p1.length);
    $("p2Prompt").innerHTML=promptHTML(p2[state.idx.p2], state.idx.p2+1, p2.length);
    $("p3Prompt").innerHTML=promptHTML(p3[state.idx.p3], state.idx.p3+1, p3.length);

    setRecUI(false, p1[state.idx.p1].id);
    setRecUI(false, p2[state.idx.p2].id);
    setRecUI(false, p3[state.idx.p3].id);
  }

  function refreshLists(){
    const {p1,p2,p3}=getArrays();
    $("p1List").innerHTML=listHTML(p1,"p1");
    $("p2List").innerHTML=listHTML(p2,"p2");
    $("p3List").innerHTML=listHTML(p3,"p3");
  }

  function renderRecList(){
    const ids=Object.keys(recordings);
    $("recCount").textContent=String(ids.length);
    const el=$("recList");
    if(!ids.length){ el.innerHTML=`<p class="small">A√∫n no hay audios en esta sesi√≥n.</p>`; return; }
    el.innerHTML=ids.map(id=>{
      const r=recordings[id];
      return `
        <div class="prompt" style="margin-bottom:10px">
          <div class="meta">
            <span class="pill"><strong>${esc(id)}</strong></span>
            <span class="pill">${esc(r.filename)}</span>
          </div>
          <audio controls src="${r.url}"></audio>
          <div class="actions">
            <button class="btn good" data-rec="download" data-id="${esc(id)}">‚¨áÔ∏è Descargar</button>
          </div>
        </div>`;
    }).join("");
  }

  // ---------- Tabs ----------
  function setTab(tabId){
    ["overview","part1","part2","part3","recordings","instructor"].forEach(sec=>{
      $(sec).classList.toggle("hidden", sec!==tabId);
    });
    document.querySelectorAll(".tab").forEach(b=>{
      b.setAttribute("aria-selected", b.dataset.tab===tabId ? "true":"false");
    });
    if(tabId==="part1") setTimerSection("p1");
    if(tabId==="part2") setTimerSection("p2");
    if(tabId==="part3") setTimerSection("p3");
  }
  document.querySelectorAll(".tab").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

  // ---------- Events: nav/act/rec ----------
  document.body.addEventListener("click", async (e)=>{
    const nav=e.target.closest("button[data-nav]");
    if(nav){
      const which=nav.dataset.nav;
      const idx=Number(nav.dataset.index);
      if(which==="p1") state.idx.p1=idx;
      if(which==="p2") state.idx.p2=idx;
      if(which==="p3") state.idx.p3=idx;
      renderCurrent();
      window.scrollTo({top:0,behavior:"smooth"});
      return;
    }

    const act=e.target.closest("button[data-act]");
    if(act){
      const id=act.dataset.id;
      if(act.dataset.act==="done") markDone(id);
      if(act.dataset.act==="clear") clearItem(id);
      return;
    }

    const rec=e.target.closest("button[data-rec]");
    if(rec){
      const id=rec.dataset.id;
      try{
        if(rec.dataset.rec==="start") await startRecording(id);
        if(rec.dataset.rec==="stop") stopRecording(id);
        if(rec.dataset.rec==="download") downloadRecording(id);
      }catch(err){
        alert("No se pudo grabar:\n\n"+(err?.message||err));
        setRecUI(false,id);
      }
      return;
    }
  });

  document.body.addEventListener("change",(e)=>{
    const sel=e.target.closest("select[data-rubric]");
    if(!sel) return;
    setRubric(sel.dataset.id, sel.dataset.key, Number(sel.value));
  });

  // ---------- Next/Prev ----------
  $("p1Next").onclick=()=>{ const {p1}=getArrays(); state.idx.p1=Math.min(p1.length-1,state.idx.p1+1); renderCurrent(); };
  $("p1Prev").onclick=()=>{ state.idx.p1=Math.max(0,state.idx.p1-1); renderCurrent(); };
  $("p2Next").onclick=()=>{ const {p2}=getArrays(); state.idx.p2=Math.min(p2.length-1,state.idx.p2+1); renderCurrent(); };
  $("p2Prev").onclick=()=>{ state.idx.p2=Math.max(0,state.idx.p2-1); renderCurrent(); };
  $("p3Next").onclick=()=>{ const {p3}=getArrays(); state.idx.p3=Math.min(p3.length-1,state.idx.p3+1); renderCurrent(); };
  $("p3Prev").onclick=()=>{ state.idx.p3=Math.max(0,state.idx.p3-1); renderCurrent(); };

  // ---------- Student ----------
  $("studentName").value=state.student;
  $("saveName").onclick=()=>{
    state.student=$("studentName").value.trim();
    localStorage.setItem(KEY_STUDENT,state.student);
    alert("Nombre guardado. Los audios se descargar√°n con ese nombre.");
  };

  // ---------- Download all ----------
  $("downloadAll").onclick=()=>{
    const ids=Object.keys(recordings);
    if(!ids.length){ alert("A√∫n no hay audios."); return; }
    ids.forEach(id=>downloadRecording(id));
  };

  // ---------- Timer UI ----------
  $("tP1").value=String(state.timing.p1);
  $("tP2").value=String(state.timing.p2);
  $("tP3").value=String(state.timing.p3);
  $("beepOn").checked=state.beepOn;
  $("autoNext").checked=state.autoNext;

  $("tP1").onchange=()=>state.timing.p1=Number($("tP1").value);
  $("tP2").onchange=()=>state.timing.p2=Number($("tP2").value);
  $("tP3").onchange=()=>state.timing.p3=Number($("tP3").value);
  $("beepOn").onchange=()=>state.beepOn=$("beepOn").checked;
  $("autoNext").onchange=()=>state.autoNext=$("autoNext").checked;
  $("startTimer").onclick=()=>startTimer();
  $("stopTimer").onclick=()=>stopTimer();

  // ---------- Randomize ----------
  $("shuffleP1").onclick=()=>{ const {p1}=getArrays(); setOrder("p1", shuffleArray(p1)); state.idx.p1=0; refreshLists(); renderCurrent(); };
  $("shuffleP2").onclick=()=>{ const {p2}=getArrays(); setOrder("p2", shuffleArray(p2)); state.idx.p2=0; refreshLists(); renderCurrent(); };
  $("shuffleP3").onclick=()=>{ const {p3}=getArrays(); setOrder("p3", shuffleArray(p3)); state.idx.p3=0; refreshLists(); renderCurrent(); };
  $("shuffleAll").onclick=()=>{
    const {p1,p2,p3}=getArrays();
    setOrder("p1", shuffleArray(p1));
    setOrder("p2", shuffleArray(p2));
    setOrder("p3", shuffleArray(p3));
    state.idx={p1:0,p2:0,p3:0};
    refreshLists(); renderCurrent();
  };

  // ---------- Reset ----------
  $("resetAll").onclick=()=>{
    if(!confirm("¬øBorrar progreso y r√∫bricas?")) return;
    state.progress={};
    saveProgress();
    updateOverview();
    refreshLists();
    renderCurrent();
  };

  // ---------- Instructor ----------
  function setInstructorUI(){
    $("instState").textContent = state.instUnlocked ? "Desbloqueado" : "Bloqueado";
    $("instPanel").classList.toggle("hidden", !state.instUnlocked);
    localStorage.setItem(KEY_INST, state.instUnlocked ? "true":"false");
    updateOverview();
  }
  $("instLogin").onclick=()=>{
    const pass=$("instPass").value.trim();
    if(pass && pass===state.instPass){
      state.instUnlocked=true;
      $("instPass").value="";
      setInstructorUI();
      alert("Instructor desbloqueado.");
    }else{
      alert("Clave incorrecta.");
    }
  };
  $("instLogout").onclick=()=>{
    state.instUnlocked=false;
    setInstructorUI();
  };
  $("saveNewPass").onclick=()=>{
    if(!state.instUnlocked){ alert("Primero desbloquea Instructor."); return; }
    const np=$("newPass").value.trim();
    if(np.length<4){ alert("Usa una clave de 4+ caracteres."); return; }
    state.instPass=np;
    localStorage.setItem(KEY_PASS, state.instPass);
    $("newPass").value="";
    alert("Clave actualizada.");
  };

  function downloadText(filename, text){
    const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  $("exportScores").onclick=()=>{
    if(!state.instUnlocked){ alert("Primero desbloquea Instructor."); return; }
    const {all}=getArrays();
    const rows=[["id","section","accuracy","completeness","delivery","protocol","final","done"].join(",")];
    for(const it of all){
      const v=state.progress[it.id]||defaultRubric();
      const sec=it.id.startsWith("P1-")?"P1":it.id.startsWith("P2-")?"P2":"P3";
      rows.push([it.id,sec,v.accuracy,v.completeness,v.delivery,v.protocol,(typeof v.final==="number"?v.final:""),(v.done?"yes":"no")].join(","));
    }
    downloadText(`BIG_mock_rubric_${(state.student||"student").replace(/[^\w\-]+/g,"_")}.csv`, rows.join("\n"));
  };

  // ---------- Init ----------
  setInstructorUI();
  updateOverview();
  refreshLists();
  renderCurrent();
  renderRecList();
  setTab("overview");
</script>
</body>
</html>
